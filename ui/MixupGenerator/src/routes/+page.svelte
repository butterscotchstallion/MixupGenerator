<script lang="ts">
	import type { ITeam } from '$lib/i-team';
	import type { ITeamMember } from '$lib/i-team-member';
	import type { ITeamMemberLinkResponse } from '$lib/i-team-member-link-response';
	import type { ITeamResponse } from '$lib/i-team-response';
	import { Tab, TabGroup, popup } from '@skeletonlabs/skeleton';
	import { BehaviorSubject, Subscription, forkJoin } from 'rxjs';
	import { onDestroy, onMount } from 'svelte';
	import { Icon } from 'svelte-icons-pack';
	import { BsCalendar2Date, BsCalendarPlus, BsKey } from 'svelte-icons-pack/bs';
	import Time from 'svelte-time';

	const teams$ = new BehaviorSubject<ITeam[]>([]);
	const subscriptions = new Subscription();
	let tabSet: number = 0;

	async function parseTeamsData() {
		subscriptions.add(
			getTeamsData$().subscribe(async (responses) => {
				const teams: ITeam[] = [];
				const teamMembersResponse: ITeamMember[] = JSON.parse(
					await responses[2].text(),
				).team_members;
				const teamsResponse: ITeamResponse[] = JSON.parse(await responses[0].text()).teams;
				const teamMembersLinksResponse: ITeamMemberLinkResponse[] = JSON.parse(
					await responses[1].text(),
				).team_member_team_link;
				const teamIdToTeamMembersMap: Map<number, ITeamMember[]> = new Map<number, ITeamMember[]>();
				const teamMemberIdToTeamMembersMap: Map<number, ITeamMember> = new Map<
					number,
					ITeamMember
				>();

				teamMembersResponse?.forEach((teamMember: ITeamMember) => {
					teamMemberIdToTeamMembersMap.set(teamMember.id, teamMember);
				});

				/**
				 * 1. Iterate team members links and build a map of
				 * team -> team members
				 * 2. Since team members can be on multiple teams, we have
				 * to account for the scenario of seeing the same team again
				 * and merge the members
				 * 3. The value for the map is a list of team members
				 *
				 */
				teamMembersLinksResponse.forEach((teamMembers: ITeamMemberLinkResponse) => {
					const existingTeamMembers = teamIdToTeamMembersMap.get(teamMembers.team_id);
					const teamMember = teamMemberIdToTeamMembersMap.get(teamMembers.team_member_id);

					if (teamMember) {
						let members: ITeamMember[] = [teamMember];

						if (existingTeamMembers) {
							members = [...existingTeamMembers, teamMember];
						}

						teamIdToTeamMembersMap.set(teamMembers.team_id, members);
					}
				});

				teamsResponse.forEach((team: ITeam) => {
					const members: ITeamMember[] = teamIdToTeamMembersMap.get(team.id) || [];
					members.sort((a: ITeamMember, b: ITeamMember) => a.name.localeCompare(b.name));
					team.members = members;
					teams.push(team);
				});

				teams.sort((a: ITeam, b: ITeam) => a.name.localeCompare(b.name));

				teams$.next(teams);
			}),
		);
	}

	function getTeamsData$() {
		return forkJoin([
			fetch('http://127.0.0.1:8000/api/teams'),
			fetch('http://127.0.0.1:8000/api/team-member-team-link'),
			fetch('http://127.0.0.1:8000/api/team-members'),
		]);
	}

	onDestroy(() => {
		subscriptions.unsubscribe();
	});

	onMount(() => {
		parseTeamsData();
	});
</script>

<div class="container h-full mx-auto flex justify-center">
	<div class="grid grid-flow-row auto-rows-max">
		<h1 class="h1 m-1">
			<span
				class="bg-gradient-to-br from-red-500 to-yellow-500 bg-clip-text text-transparent box-decoration-clone"
			>
				Mixup Generator
			</span>
		</h1>

		<TabGroup>
			<Tab
				bind:group={tabSet}
				name="tab1"
				value={0}
			>
				<span>Teams</span>
			</Tab>
			<Tab
				bind:group={tabSet}
				name="tab2"
				value={1}>Mix Ups</Tab
			>
			<Tab
				bind:group={tabSet}
				name="tab3"
				value={2}>Meetings</Tab
			>
			<!-- Tab Panels --->
			<svelte:fragment slot="panel">
				{#if tabSet === 0}
					<div class="table-container">
						<!-- Native Table Element -->
						<table class="table table-hover">
							<thead>
								<tr>
									<th>Teams</th>
									<th>Members</th>
								</tr>
							</thead>
							<tbody>
								{#if teams$ === null}
									<tr><td colspan="2"><div class="placeholder" /></td></tr>
									<tr><td colspan="2"><div class="placeholder" /></td></tr>
									<tr><td colspan="2"><div class="placeholder" /></td></tr>
									<tr><td colspan="2"><div class="placeholder" /></td></tr>
								{:else}
									{#each $teams$ as team}
										<tr>
											<td>{team.name}</td>
											<td>
												{#if team?.members && team.members.length > 0}
													<ul>
														{#each team?.members as member}
															<li class="p-1">
																<a
																	class="anchor [&>*]:pointer-events-none"
																	href="#modal"
																	use:popup={{
																		event: 'hover',
																		target: 'popup-' + member.id,
																		placement: 'top',
																	}}>{member.name}</a
																>
																<div
																	class="card p-4 variant-filled-secondary"
																	data-popup="popup-{member.id}"
																>
																	<p>{member.name}</p>
																	<table>
																		<tbody>
																			<tr>
																				<td>
																					<Icon
																						className="icons"
																						src={BsCalendar2Date}
																					/>
																					Created
																				</td>
																				<td
																					>Created <Time
																						relative
																						timestamp={member.created_at}
																					/></td
																				>
																			</tr>
																			{#if member.updated_at}
																				<tr>
																					<td>
																						<Icon
																							className="icons"
																							src={BsCalendar2Date}
																						/>
																						Updated
																					</td>
																					<td>{member.updated_at}</td>
																				</tr>
																			{/if}
																			<tr>
																				<td>
																					<Icon
																						className="icons"
																						src={BsKey}
																					/>
																					KeyCloak ID
																				</td>
																				<td>{member.keycloak_user_id}</td>
																			</tr>
																			{#if member.can_attend_multiple_meetings}
																				<tr>
																					<td colspan="2">
																						<Icon
																							className="icons"
																							src={BsCalendarPlus}
																						/>
																						Can attend multiple meetings
																					</td>
																				</tr>
																			{/if}
																		</tbody>
																	</table>
																	<div class="arrow variant-filled-secondary" />
																</div>
															</li>
														{/each}
													</ul>
												{/if}
											</td>
										</tr>
									{/each}
								{/if}
							</tbody>
						</table>
					</div>
				{:else if tabSet === 1}
					Mix ups
				{:else if tabSet === 2}
					Meetings
				{/if}
			</svelte:fragment>
		</TabGroup>
	</div>
</div>

<style>
	:global(.icons) {
		display: inline;
	}
</style>
